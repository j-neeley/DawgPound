<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DawgPound - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 { font-size: 24px; }
        .navbar button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .main {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }
        
        .card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        input[type="checkbox"] {
            width: auto;
            margin: 0 8px 0 0;
            vertical-align: middle;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üêæ DawgPound</h1>
        <div>
            <span id="username-display"></span>
            <button onclick="showDashboard()">Dashboard</button>
            <button onclick="showProfile()">My Profile</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="main">
        <!-- Onboarding Section -->
        <div id="onboarding-section" class="section hidden">
            <h2>Complete Your Profile</h2>
            <p>Select your majors and interests to get personalized group recommendations!</p>
            <br>
            <form onsubmit="completeOnboarding(event)">
                <label>Majors (select at least 1):</label>
                <div id="majors-list"></div>
                <br>
                <label>Interests & Hobbies (select at least 3):</label>
                <div id="interests-list"></div>
                <br>
                <label>Year of Study:</label>
                <select id="year">
                    <option value="">Select...</option>
                    <option>Freshman</option>
                    <option>Sophomore</option>
                    <option>Junior</option>
                    <option>Senior</option>
                    <option>Graduate</option>
                </select>
                <label>Graduation Year:</label>
                <input type="number" id="grad-year" min="2024" max="2030">
                <br>
                <button type="submit" class="btn btn-primary">Complete Profile</button>
            </form>
        </div>
        
        <!-- Profile Edit Section -->
        <div id="profile-section" class="section hidden">
            <h2>Edit Profile</h2>
            <form id="profile-form" onsubmit="updateProfile(event)">
                <label>Username:</label>
                <input type="text" id="profile-username" required>
                <br>
                <label>Email:</label>
                <input type="email" id="profile-email" required>
                <br>
                <label>Year of Study:</label>
                <select id="profile-year">
                    <option value="">Select...</option>
                    <option value="freshman">Freshman</option>
                    <option value="sophomore">Sophomore</option>
                    <option value="junior">Junior</option>
                    <option value="senior">Senior</option>
                    <option value="graduate">Graduate</option>
                </select>
                <br>
                <label>Graduation Year:</label>
                <input type="number" id="profile-grad-year" min="2020" max="2035">
                <br><br>
                
                <h3>Majors (Select at least one)</h3>
                <div id="profile-majors" class="checkbox-group"></div>
                
                <h3>Interests & Hobbies (Select at least 3)</h3>
                <div id="profile-interests" class="checkbox-group"></div>
                <br>
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="showDashboard()">Cancel</button>
            </form>
        </div>
        
        <!-- Groups Section -->
        <div id="groups-section" class="section hidden">
            <h2>Public Groups</h2>
            <button class="btn btn-primary" onclick="showCreateGroup()">Create Group</button>
            <input type="text" id="search-groups" placeholder="Search groups..." onkeyup="searchGroups()">
            <br><br>
            <div id="groups-grid" class="grid"></div>
        </div>
        
        <!-- Create Group Modal -->
        <div id="create-group-modal" class="section hidden">
            <h2>Create New Group</h2>
            <form onsubmit="createGroup(event)">
                <input type="text" id="group-name" placeholder="Group Name" required>
                <textarea id="group-description" placeholder="Description" rows="3"></textarea>
                <select id="group-category" required>
                    <option value="">Select Category</option>
                    <option value="class_year">Class Year</option>
                    <option value="major">Major</option>
                    <option value="interests_activities">Interests & Activities</option>
                    <option value="other">Other</option>
                </select>
                <button type="submit" class="btn btn-primary">Create</button>
                <button type="button" class="btn btn-secondary" onclick="hideCreateGroup()">Cancel</button>
            </form>
        </div>
        
        <!-- Forums Section -->
        <div id="forums-section" class="section hidden">
            <h2 id="forum-title">Forum Threads</h2>
            <button class="btn btn-secondary" onclick="showGroups()">Back to Groups</button>
            <button class="btn btn-primary" onclick="showCreateThread()">New Thread</button>
            <br><br>
            <div id="threads-list"></div>
        </div>
        
        <!-- Thread View Section -->
        <div id="thread-view-section" class="section hidden">
            <button class="btn btn-secondary" onclick="backToForum()">Back to Forum</button>
            <br><br>
            <div id="thread-content"></div>
            <br>
            <h3>Replies</h3>
            <div id="replies-list"></div>
            <br>
            <h4>Post a Reply</h4>
            <form id="reply-form" onsubmit="postReply(event)">
                <textarea id="reply-content" placeholder="Write your reply..." rows="4" required></textarea>
                <button type="submit" class="btn btn-primary">Post Reply</button>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let currentGroup = null;
        let currentGroupName = null;
        let taxonomy = null;
        
        async function init() {
            console.log('Init starting...');
            try {
                const response = await fetch(`${API_BASE}/users/me/`, { credentials: 'include' });
                console.log('Me response:', response.ok);
                if (!response.ok) {
                    window.location.href = '/test/';
                    return;
                }
                currentUser = await response.json();
                console.log('Current user:', currentUser);
                document.getElementById('username-display').textContent = currentUser.username;
                
                // Load taxonomy
                const taxResp = await fetch(`${API_BASE}/taxonomy/`);
                taxonomy = await taxResp.json();
                console.log('Taxonomy loaded');
                
                // Check if onboarding needed
                if (!currentUser.onboarding_completed) {
                    console.log('Showing onboarding');
                    showOnboarding();
                } else {
                    console.log('Loading groups');
                    loadGroups();
                }
            } catch (error) {
                console.error('Init error:', error);
                window.location.href = '/test/';
            }
        }
        
        function showOnboarding() {
            document.getElementById('onboarding-section').classList.remove('hidden');
            document.getElementById('groups-section').classList.add('hidden');
            
            // Populate majors
            const majorsList = document.getElementById('majors-list');
            majorsList.innerHTML = taxonomy.majors.map(m => 
                `<label class="checkbox-label"><input type="checkbox" name="major" value="${m}"> ${m}</label>`
            ).join('');
            
            // Populate interests
            const interestsList = document.getElementById('interests-list');
            interestsList.innerHTML = taxonomy.interests.map(i => 
                `<label class="checkbox-label"><input type="checkbox" name="interest" value="${i}"> ${i}</label>`
            ).join('');
        }
        
        async function completeOnboarding(event) {
            event.preventDefault();
            
            const majors = Array.from(document.querySelectorAll('input[name="major"]:checked')).map(cb => cb.value);
            const interests = Array.from(document.querySelectorAll('input[name="interest"]:checked')).map(cb => cb.value);
            
            if (majors.length < 1) {
                alert('Please select at least 1 major');
                return;
            }
            if (interests.length < 3) {
                alert('Please select at least 3 interests');
                return;
            }
            
            const data = {
                majors,
                interests_hobbies: interests,
                year_of_study: document.getElementById('year').value,
                graduation_year: parseInt(document.getElementById('grad-year').value) || null
            };
            
            const response = await fetch(`${API_BASE}/users/onboarding/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const result = await response.json();
                currentUser = result.user;
                document.getElementById('onboarding-section').classList.add('hidden');
                loadGroups();
            }
        }
        
        async function loadGroups() {
            document.getElementById('groups-section').classList.remove('hidden');
            const response = await fetch(`${API_BASE}/groups/`, { credentials: 'include' });
            const groups = await response.json();
            
            const grid = document.getElementById('groups-grid');
            grid.innerHTML = groups.results ? groups.results.map(g => `
                <div class="card">
                    <h3>${g.name}</h3>
                    <p>${g.description || 'No description'}</p>
                    <p><small>${g.category} ‚Ä¢ ${g.member_count} members</small></p>
                    <button class="btn ${g.is_member ? 'btn-secondary' : 'btn-primary'}" 
                            onclick="${g.is_member ? `leaveGroup(${g.id})` : `joinGroup(${g.id})`}">
                        ${g.is_member ? 'Leave' : 'Join'}
                    </button>
                    <button class="btn btn-secondary" onclick="viewForum(${g.id}, '${g.name}')">View Forum</button>
                </div>
            `).join('') : 'No groups yet';
        }
        
        function showCreateGroup() {
            document.getElementById('create-group-modal').classList.remove('hidden');
        }
        
        function hideCreateGroup() {
            document.getElementById('create-group-modal').classList.add('hidden');
        }
        
        async function createGroup(event) {
            event.preventDefault();
            const data = {
                name: document.getElementById('group-name').value,
                description: document.getElementById('group-description').value,
                category: document.getElementById('group-category').value,
                tags: []
            };
            
            const response = await fetch(`${API_BASE}/groups/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                hideCreateGroup();
                loadGroups();
            }
        }
        
        async function joinGroup(id) {
            await fetch(`${API_BASE}/groups/${id}/join/`, {
                method: 'POST',
                credentials: 'include'
            });
            loadGroups();
        }
        
        async function leaveGroup(id) {
            await fetch(`${API_BASE}/groups/${id}/leave/`, {
                method: 'POST',
                credentials: 'include'
            });
            loadGroups();
        }
        
        async function viewForum(groupId, groupName) {
            currentGroup = groupId;
            currentGroupName = groupName;
            document.getElementById('groups-section').classList.add('hidden');
            document.getElementById('forums-section').classList.remove('hidden');
            document.getElementById('forum-title').textContent = `${groupName} - Forum`;
            
            const response = await fetch(`${API_BASE}/threads/?group=${groupId}`, { credentials: 'include' });
            const threads = await response.json();
            
            const list = document.getElementById('threads-list');
            const isAdmin = currentUser.is_staff || currentUser.is_superuser;
            list.innerHTML = (threads.results ? threads.results.map(t => `
                <div class="card">
                    <h3>${t.title}</h3>
                    <p>${t.content.substring(0, 200)}...</p>
                    <p><small>By ${t.author_username} ‚Ä¢ ${t.reply_count} replies</small></p>
                    <button class="btn btn-primary" onclick="viewThread(${t.id})">View</button>
                    ${isAdmin || t.author === currentUser.id ? `
                        <button class="btn btn-secondary" onclick="deleteThread(${t.id})">Delete</button>
                    ` : ''}
                </div>
            `).join('') : '') || 'No threads yet';
        }
        
        function showGroups() {
            document.getElementById('forums-section').classList.add('hidden');
            document.getElementById('groups-section').classList.remove('hidden');
            document.getElementById('onboarding-section').classList.add('hidden');
            currentGroup = null;
        }
        
        function showDashboard() {
            document.getElementById('forums-section').classList.add('hidden');
            document.getElementById('onboarding-section').classList.add('hidden');
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('thread-view-section').classList.add('hidden');
            document.getElementById('groups-section').classList.remove('hidden');
            document.getElementById('create-group-modal').classList.add('hidden');
            loadGroups();
        }
        
        async function showProfile() {
            document.getElementById('forums-section').classList.add('hidden');
            document.getElementById('groups-section').classList.add('hidden');
            document.getElementById('onboarding-section').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            
            // Populate taxonomy checkboxes if not already done
            const profileMajors = document.getElementById('profile-majors');
            if (!profileMajors.innerHTML) {
                profileMajors.innerHTML = taxonomy.majors.map(m => 
                    `<label class="checkbox-label"><input type="checkbox" name="major" value="${m}"> ${m}</label>`
                ).join('');
            }
            const profileInterests = document.getElementById('profile-interests');
            if (!profileInterests.innerHTML) {
                profileInterests.innerHTML = taxonomy.interests.map(i => 
                    `<label class="checkbox-label"><input type="checkbox" name="interest" value="${i}"> ${i}</label>`
                ).join('');
            }
            
            // Populate form with current values
            document.getElementById('profile-username').value = currentUser.username;
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-year').value = currentUser.year_of_study || '';
            document.getElementById('profile-grad-year').value = currentUser.graduation_year || '';
            
            // Check current majors and interests
            document.querySelectorAll('#profile-majors input[type="checkbox"]').forEach(cb => {
                cb.checked = currentUser.majors.includes(cb.value);
            });
            document.querySelectorAll('#profile-interests input[type="checkbox"]').forEach(cb => {
                cb.checked = currentUser.interests_hobbies.includes(cb.value);
            });
        }
        
        async function updateProfile(event) {
            event.preventDefault();
            
            const majors = Array.from(document.querySelectorAll('#profile-majors input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const interests = Array.from(document.querySelectorAll('#profile-interests input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (majors.length === 0) {
                alert('Please select at least one major');
                return;
            }
            
            if (interests.length < 3) {
                alert('Please select at least 3 interests');
                return;
            }
            
            try {
                // Update basic info (username, email)
                const userResponse = await fetch(`${API_BASE}/users/${currentUser.id}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: document.getElementById('profile-username').value,
                        email: document.getElementById('profile-email').value
                    })
                });
                
                if (!userResponse.ok) {
                    const error = await userResponse.json();
                    alert('Error updating profile: ' + JSON.stringify(error));
                    return;
                }
                
                // Update onboarding data (majors, interests, year, grad year)
                const onboardingData = {
                    majors,
                    interests_hobbies: interests,
                    year_of_study: document.getElementById('profile-year').value,
                    graduation_year: parseInt(document.getElementById('profile-grad-year').value) || null
                };
                
                const onboardingResponse = await fetch(`${API_BASE}/users/onboarding/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(onboardingData)
                });
                
                if (onboardingResponse.ok) {
                    const result = await onboardingResponse.json();
                    currentUser = result.user;
                    alert('Profile updated successfully!');
                    showDashboard();
                } else {
                    const error = await onboardingResponse.json();
                    alert('Error updating onboarding data: ' + JSON.stringify(error));
                }
            } catch (error) {
                alert('Error updating profile: ' + error.message);
            }
        }
        
        async function showCreateThread() {
            const title = prompt('Thread title:');
            if (!title) return;
            
            const content = prompt('Thread content:');
            if (!content) return;
            
            try {
                const response = await fetch(`${API_BASE}/threads/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        group: currentGroup,
                        title,
                        content,
                        content_type: 'plain'
                    })
                });
                
                if (response.ok) {
                    alert('Thread created successfully!');
                    viewForum(currentGroup, currentGroupName);
                } else {
                    const error = await response.json();
                    alert('Error creating thread: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('Thread creation error:', error);
                alert('Error creating thread: ' + error.message);
            }
        }
        
        async function searchGroups() {
            const query = document.getElementById('search-groups').value;
            const response = await fetch(`${API_BASE}/groups/?search=${query}`, { credentials: 'include' });
            const groups = await response.json();
            // Update grid...
        }
        
        async function deleteThread(threadId) {
            if (!confirm('Are you sure you want to delete this thread?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/threads/${threadId}/`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('Thread deleted successfully!');
                    viewForum(currentGroup, currentGroupName);
                } else {
                    const error = await response.json();
                    alert('Error deleting thread: ' + JSON.stringify(error));
                }
            } catch (error) {
                alert('Error deleting thread: ' + error.message);
            }
        }
        
        let currentThread = null;
        
        async function viewThread(threadId) {
            currentThread = threadId;
            document.getElementById('forums-section').classList.add('hidden');
            document.getElementById('thread-view-section').classList.remove('hidden');
            
            try {
                // Get thread details
                const threadResp = await fetch(`${API_BASE}/threads/${threadId}/`, { credentials: 'include' });
                const thread = await threadResp.json();
                
                // Display thread content
                const isAdmin = currentUser.is_staff || currentUser.is_superuser;
                document.getElementById('thread-content').innerHTML = `
                    <div class="card">
                        <h2>${thread.title}</h2>
                        <p>${thread.content}</p>
                        <p><small>By ${thread.author_username} on ${new Date(thread.created_at).toLocaleString()}</small></p>
                        ${isAdmin || thread.author === currentUser.id ? `
                            <button class="btn btn-secondary" onclick="deleteThread(${thread.id}); backToForum();">Delete Thread</button>
                        ` : ''}
                    </div>
                `;
                
                // Get replies
                const repliesResp = await fetch(`${API_BASE}/threads/${threadId}/replies/`, { credentials: 'include' });
                const replies = await repliesResp.json();
                
                // Display replies
                const repliesList = document.getElementById('replies-list');
                repliesList.innerHTML = replies.length > 0 ? replies.map(r => `
                    <div class="card">
                        <p>${r.content}</p>
                        <p><small>By ${r.author_username} on ${new Date(r.created_at).toLocaleString()}</small></p>
                        ${isAdmin || r.author === currentUser.id ? `
                            <button class="btn btn-secondary" onclick="deleteReply(${r.id})">Delete Reply</button>
                        ` : ''}
                    </div>
                `).join('') : '<p>No replies yet. Be the first to reply!</p>';
            } catch (error) {
                alert('Error loading thread: ' + error.message);
            }
        }
        
        function backToForum() {
            document.getElementById('thread-view-section').classList.add('hidden');
            document.getElementById('forums-section').classList.remove('hidden');
            currentThread = null;
        }
        
        async function postReply(event) {
            event.preventDefault();
            
            const content = document.getElementById('reply-content').value;
            if (!content) return;
            
            try {
                const response = await fetch(`${API_BASE}/threads/${currentThread}/reply/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ content })
                });
                
                if (response.ok) {
                    document.getElementById('reply-content').value = '';
                    viewThread(currentThread); // Reload thread to show new reply
                } else {
                    const error = await response.json();
                    alert('Error posting reply: ' + JSON.stringify(error));
                }
            } catch (error) {
                alert('Error posting reply: ' + error.message);
            }
        }
        
        async function deleteReply(replyId) {
            if (!confirm('Are you sure you want to delete this reply?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/replies/${replyId}/`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    viewThread(currentThread); // Reload thread
                } else {
                    const error = await response.json();
                    alert('Error deleting reply: ' + JSON.stringify(error));
                }
            } catch (error) {
                alert('Error deleting reply: ' + error.message);
            }
        }
        
        async function logout() {
            await fetch(`${API_BASE}/users/logout/`, { method: 'POST', credentials: 'include' });
            window.location.href = '/test/';
        }
        
        init();
    </script>
</body>
</html>
