version: '3.8'
services:
  nginx:
    image: nginx:latest
    ports:
      - '8000:443'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - django
    command: sh -c "openssl req -x509 -newkey rsa:2048 -keyout /etc/nginx/certs/key.pem -out /etc/nginx/certs/cert.pem -days 365 -nodes -subj '/CN=localhost' 2>/dev/null || true && nginx -g 'daemon off;'"

  django:
    build:
      context: .
      dockerfile: Dockerfile.django
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-dev-key}
      - USE_POSTGRES=false
      - ALLOWED_HOSTS=*
    volumes:
      - ./backend:/app
    command: python manage.py runserver 0.0.0.0:8000

  # Optional: PostgreSQL database (not used by default, SQLite is default)
  # Uncomment and set USE_POSTGRES=true in django service to use
  # postgres:
  #   image: postgres:15-alpine
  #   environment:
  #     POSTGRES_USER: dp
  #     POSTGRES_PASSWORD: dp
  #     POSTGRES_DB: dawg
  #   ports:
  #     - '5432:5432'
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data

# volumes:
#   postgres_data:
